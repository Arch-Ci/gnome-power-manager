<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GNOME Power Manager: gpm-prefs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>gpm-prefs.c</h1><a href="gpm-prefs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00012"></a>00012 <span class="comment">/*</span>
<a name="l00013"></a>00013 <span class="comment"> * Licensed under the GNU General Public License Version 2</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00016"></a>00016 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00018"></a>00018 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00021"></a>00021 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00022"></a>00022 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00023"></a>00023 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00026"></a>00026 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00027"></a>00027 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<a name="l00028"></a>00028 <span class="comment"> * 02110-1301, USA.</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;config.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#endif</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;glib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;dbus/dbus-glib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;gtk/gtk.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;glade/glade.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;gconf/gconf-client.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="gpm-common_8h.html">gpm-common.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="gpm-prefs_8h.html">gpm-prefs.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="gpm-libnotify_8h.html">gpm-libnotify.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="gpm-main_8h.html">gpm-main.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="gpm-screensaver_8h.html">gpm-screensaver.h</a>"</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="dbus-common_8h.html">dbus-common.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="glibhal-main_8h.html">glibhal-main.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="glibhal-extras_8h.html">glibhal-extras.h</a>"</span>
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="gpm-prefs_8c.html#a0">00053</a> <span class="keyword">static</span> GladeXML *<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>;
<a name="l00054"></a><a class="code" href="gpm-prefs_8c.html#a1">00054</a> <span class="keyword">static</span> gboolean <a class="code" href="gpm-main_8c.html#a3">isVerbose</a>;
<a name="l00055"></a>00055 
<a name="l00061"></a>00061 gboolean
<a name="l00062"></a><a class="code" href="gpm-prefs_8c.html#a2">00062</a> <a class="code" href="gpm-prefs_8c.html#a2">gpm_is_on_ac</a> (gboolean *value)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064     DBusGConnection *session_connection = NULL;
<a name="l00065"></a>00065     DBusGProxy *gpm_proxy = NULL;
<a name="l00066"></a>00066     GError *error = NULL;
<a name="l00067"></a>00067     gboolean retval = TRUE;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="comment">/* assertion checks */</span>
<a name="l00070"></a>00070     g_assert (value);
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="keywordflow">if</span> (!<a class="code" href="dbus-common_8c.html#a2">dbus_get_session_connection</a> (&amp;session_connection))
<a name="l00073"></a>00073         <span class="keywordflow">return</span> FALSE;
<a name="l00074"></a>00074     gpm_proxy = dbus_g_proxy_new_for_name (session_connection,
<a name="l00075"></a>00075             <a class="code" href="gpm-common_8h.html#a12">GPM_DBUS_SERVICE</a>,
<a name="l00076"></a>00076             <a class="code" href="gpm-common_8h.html#a13">GPM_DBUS_PATH</a>,
<a name="l00077"></a>00077             <a class="code" href="gpm-common_8h.html#a14">GPM_DBUS_INTERFACE</a>);
<a name="l00078"></a>00078     <span class="keywordflow">if</span> (!dbus_g_proxy_call (gpm_proxy, <span class="stringliteral">"isOnAc"</span>, &amp;error,
<a name="l00079"></a>00079             G_TYPE_INVALID,
<a name="l00080"></a>00080             G_TYPE_BOOLEAN, value, G_TYPE_INVALID)) {
<a name="l00081"></a>00081         <a class="code" href="dbus-common_8c.html#a0">dbus_glib_error</a> (error);
<a name="l00082"></a>00082         *value = FALSE;
<a name="l00083"></a>00083         retval = FALSE;
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085     g_object_unref (G_OBJECT (gpm_proxy));
<a name="l00086"></a>00086     <span class="keywordflow">return</span> retval;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00094"></a>00094 gboolean
<a name="l00095"></a><a class="code" href="gpm-prefs_8c.html#a3">00095</a> <a class="code" href="gpm-prefs_8c.html#a3">gpm_is_on_mains</a> (gboolean *value)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097     DBusGConnection *session_connection = NULL;
<a name="l00098"></a>00098     DBusGProxy *gpm_proxy = NULL;
<a name="l00099"></a>00099     GError *error = NULL;
<a name="l00100"></a>00100     gboolean retval;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">/* assertion checks */</span>
<a name="l00103"></a>00103     g_assert (value);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (!<a class="code" href="dbus-common_8c.html#a2">dbus_get_session_connection</a> (&amp;session_connection))
<a name="l00106"></a>00106         <span class="keywordflow">return</span> FALSE;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     gpm_proxy = dbus_g_proxy_new_for_name (session_connection,
<a name="l00109"></a>00109             <a class="code" href="gpm-common_8h.html#a12">GPM_DBUS_SERVICE</a>, <a class="code" href="gpm-common_8h.html#a13">GPM_DBUS_PATH</a>, <a class="code" href="gpm-common_8h.html#a14">GPM_DBUS_INTERFACE</a>);
<a name="l00110"></a>00110     retval = TRUE;
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (!dbus_g_proxy_call (gpm_proxy, <span class="stringliteral">"isOnBattery"</span>, &amp;error,
<a name="l00112"></a>00112             G_TYPE_INVALID,
<a name="l00113"></a>00113             G_TYPE_BOOLEAN, value, G_TYPE_INVALID)) {
<a name="l00114"></a>00114         <a class="code" href="dbus-common_8c.html#a0">dbus_glib_error</a> (error);
<a name="l00115"></a>00115         *value = FALSE;
<a name="l00116"></a>00116         retval = FALSE;
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     g_object_unref (G_OBJECT (gpm_proxy));
<a name="l00119"></a>00119     <span class="keywordflow">return</span> retval;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00130"></a><a class="code" href="gpm-prefs_8c.html#a4">00130</a> <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="keyword">const</span> gchar *widgetname, gboolean set)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     GtkWidget *widget = NULL;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="comment">/* assertion checks */</span>
<a name="l00135"></a>00135     g_assert (widgetname);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (!widget) {
<a name="l00139"></a>00139         g_warning (<span class="stringliteral">"gtk_set_visibility: widget '%s' not found"</span>,
<a name="l00140"></a>00140                 widgetname);
<a name="l00141"></a>00141         <span class="keywordflow">return</span>;
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (set)
<a name="l00145"></a>00145         gtk_widget_show_all (widget);
<a name="l00146"></a>00146     <span class="keywordflow">else</span>
<a name="l00147"></a>00147         gtk_widget_hide_all (widget);
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00155"></a>00155 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00156"></a><a class="code" href="gpm-prefs_8c.html#a5">00156</a> <a class="code" href="gpm-prefs_8c.html#a5">gtk_set_check</a> (<span class="keyword">const</span> gchar *widgetname, gboolean set)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     GtkWidget *widget = NULL;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">/* assertion checks */</span>
<a name="l00161"></a>00161     g_assert (widgetname);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!widget) {
<a name="l00165"></a>00165         g_warning (<span class="stringliteral">"widget '%s' failed to load, aborting"</span>, widgetname);
<a name="l00166"></a>00166         <span class="keywordflow">return</span>;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), set);
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="gpm-prefs_8c.html#a6">00177</a> <a class="code" href="gpm-prefs_8c.html#a6">gtk_set_label</a> (<span class="keyword">const</span> gchar *widgetname, <span class="keyword">const</span> gchar *label)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179     GtkWidget *widget = NULL;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">/* assertion checks */</span>
<a name="l00182"></a>00182     g_assert (widgetname);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00185"></a>00185     gtk_label_set_markup (GTK_LABEL (widget), label);
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00192"></a>00192 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00193"></a><a class="code" href="gpm-prefs_8c.html#a7">00193</a> <a class="code" href="gpm-prefs_8c.html#a7">recalc</a> (<span class="keywordtype">void</span>)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     GtkWidget *widget = NULL;
<a name="l00196"></a>00196     GConfClient *client = gconf_client_get_default ();
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     gboolean hasBatteries;
<a name="l00199"></a>00199     gboolean hasAcAdapter;
<a name="l00200"></a>00200     gboolean hasButtonPower;
<a name="l00201"></a>00201     gboolean hasButtonSleep;
<a name="l00202"></a>00202     gboolean hasButtonLid;
<a name="l00203"></a>00203     gboolean hasLCD;
<a name="l00204"></a>00204     gboolean hasDisplays;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">/* checkboxes */</span>
<a name="l00207"></a>00207     gboolean displayIcon = gconf_client_get_bool (client, 
<a name="l00208"></a>00208         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/display_icon"</span>, NULL);
<a name="l00209"></a>00209     gboolean displayIconFull = gconf_client_get_bool (client,
<a name="l00210"></a>00210         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/display_icon_full"</span>, NULL);
<a name="l00211"></a>00211     <a class="code" href="gpm-prefs_8c.html#a5">gtk_set_check</a> (<span class="stringliteral">"checkbutton_display_icon"</span>, displayIcon);
<a name="l00212"></a>00212     <a class="code" href="gpm-prefs_8c.html#a5">gtk_set_check</a> (<span class="stringliteral">"checkbutton_display_icon_full"</span>, displayIconFull);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     hasBatteries =   (<a class="code" href="glibhal-main_8c.html#a7">hal_num_devices_of_capability</a> (<span class="stringliteral">"battery"</span>) &gt; 0);
<a name="l00215"></a>00215     hasAcAdapter =   (<a class="code" href="glibhal-main_8c.html#a7">hal_num_devices_of_capability</a> (<span class="stringliteral">"ac_adapter"</span>) &gt; 0);
<a name="l00216"></a>00216     hasButtonPower = (<a class="code" href="glibhal-main_8c.html#a8">hal_num_devices_of_capability_with_value</a>
<a name="l00217"></a>00217                 (<span class="stringliteral">"button"</span>, <span class="stringliteral">"button.type"</span>, <span class="stringliteral">"power"</span>) &gt; 0);
<a name="l00218"></a>00218     hasButtonSleep = (<a class="code" href="glibhal-main_8c.html#a8">hal_num_devices_of_capability_with_value</a>
<a name="l00219"></a>00219                 (<span class="stringliteral">"button"</span>, <span class="stringliteral">"button.type"</span>, <span class="stringliteral">"sleep"</span>) &gt; 0);
<a name="l00220"></a>00220     hasButtonLid =   (<a class="code" href="glibhal-main_8c.html#a8">hal_num_devices_of_capability_with_value</a>
<a name="l00221"></a>00221                 (<span class="stringliteral">"button"</span>, <span class="stringliteral">"button.type"</span>, <span class="stringliteral">"lid"</span>) &gt; 0);
<a name="l00222"></a>00222 <span class="preprocessor">#if 0</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>    hasHardDrive =   (<a class="code" href="glibhal-main_8c.html#a8">hal_num_devices_of_capability_with_value</a>
<a name="l00224"></a>00224                 (<span class="stringliteral">"storage"</span>, <span class="stringliteral">"storage.bus"</span>, <span class="stringliteral">"ide"</span>) &gt; 0);
<a name="l00225"></a>00225 <span class="preprocessor">#endif</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>    hasLCD =     (<a class="code" href="glibhal-main_8c.html#a7">hal_num_devices_of_capability</a> (<span class="stringliteral">"laptop_panel"</span>) &gt; 0);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (<a class="code" href="gpm-screensaver_8c.html#a2">gscreensaver_is_running</a> ()) {
<a name="l00229"></a>00229         <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"button_gnome_screensave"</span>, TRUE);
<a name="l00230"></a>00230         hasDisplays = gconf_client_get_bool (client,
<a name="l00231"></a>00231                 <a class="code" href="gpm-screensaver_8h.html#a3">GS_GCONF_ROOT</a> <span class="stringliteral">"dpms_enabled"</span>, NULL);
<a name="l00232"></a>00232     } <span class="keywordflow">else</span> {
<a name="l00233"></a>00233         <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"button_gnome_screensave"</span>, FALSE);
<a name="l00234"></a>00234         hasDisplays = FALSE;
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="comment">/* frame labels */</span>
<a name="l00238"></a>00238     <span class="keywordflow">if</span> (hasBatteries) {
<a name="l00239"></a>00239         widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"label_frame_ac"</span>);
<a name="l00240"></a>00240         gtk_label_set_markup (GTK_LABEL (widget), <span class="stringliteral">"&lt;b&gt;Running on AC adapter&lt;/b&gt;"</span>);
<a name="l00241"></a>00241         widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"label_frame_batteries"</span>);
<a name="l00242"></a>00242         gtk_label_set_markup (GTK_LABEL (widget), <span class="stringliteral">"&lt;b&gt;Running on batteries&lt;/b&gt;"</span>);
<a name="l00243"></a>00243     } <span class="keywordflow">else</span> {
<a name="l00244"></a>00244         widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"label_frame_ac"</span>);
<a name="l00245"></a>00245         gtk_label_set_markup (GTK_LABEL (widget), <span class="stringliteral">"&lt;b&gt;Configuration&lt;/b&gt;"</span>);
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="comment">/* top frame */</span>
<a name="l00249"></a>00249     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"frame_batteries"</span>, hasBatteries);
<a name="l00250"></a>00250     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"combobox_battery_critical"</span>, hasBatteries);
<a name="l00251"></a>00251     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_battery_critical_action"</span>, hasBatteries);
<a name="l00252"></a>00252     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_battery_critical"</span>, hasBatteries);
<a name="l00253"></a>00253     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_battery_low"</span>, hasBatteries);
<a name="l00254"></a>00254     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_battery_low"</span>, hasBatteries);
<a name="l00255"></a>00255     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_battery_critical"</span>, hasBatteries);
<a name="l00256"></a>00256     <span class="comment">/* assumes only battery options are in this frame */</span>
<a name="l00257"></a>00257     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"frame_other_options"</span>, hasBatteries);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">/* options */</span>
<a name="l00260"></a>00260     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"combobox_button_lid"</span>, hasButtonLid);
<a name="l00261"></a>00261     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_button_lid"</span>, hasButtonLid);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"combobox_button_power"</span>, hasButtonPower);
<a name="l00264"></a>00264     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_button_power"</span>, hasButtonPower);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"combobox_button_suspend"</span>, hasButtonSleep);
<a name="l00267"></a>00267     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_button_suspend"</span>, hasButtonSleep);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"combobox_ac_fail"</span>, hasAcAdapter);
<a name="l00270"></a>00270     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_ac_fail"</span>, hasAcAdapter);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* variables */</span>
<a name="l00273"></a>00273     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_ac_brightness"</span>, hasLCD);
<a name="l00274"></a>00274     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_ac_brightness"</span>, hasLCD);
<a name="l00275"></a>00275     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_batteries_brightness"</span>, hasLCD);
<a name="l00276"></a>00276     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_batteries_brightness"</span>, hasLCD);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_ac_display"</span>, hasDisplays);
<a name="l00279"></a>00279     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_ac_display"</span>, hasDisplays);
<a name="l00280"></a>00280     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_batteries_display"</span>, hasDisplays &amp; hasBatteries);
<a name="l00281"></a>00281     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_batteries_display"</span>, hasDisplays &amp; hasBatteries);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="comment">/* set the display stuff to set gnome-screensaver dpms timeout */</span>
<a name="l00284"></a>00284     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_ac_display"</span>, hasDisplays);
<a name="l00285"></a>00285     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_ac_display"</span>, hasDisplays);
<a name="l00286"></a>00286     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"hscale_batteries_display"</span>, hasDisplays &amp; hasBatteries);
<a name="l00287"></a>00287     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_batteries_display"</span>, hasDisplays &amp; hasBatteries);
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00297"></a>00297 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00298"></a><a class="code" href="gpm-prefs_8c.html#a8">00298</a> <a class="code" href="gpm-main_8c.html#a5">callback_gconf_key_changed</a> (GConfClient *client,
<a name="l00299"></a>00299     guint cnxn_id,
<a name="l00300"></a>00300     GConfEntry *entry,
<a name="l00301"></a>00301     gpointer user_data)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303     <span class="comment">/* assertion checks */</span>
<a name="l00304"></a>00304     g_assert (client);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (gconf_entry_get_value (entry) == NULL)
<a name="l00307"></a>00307         <span class="keywordflow">return</span>;
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00317"></a>00317 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00318"></a><a class="code" href="gpm-prefs_8c.html#a9">00318</a> <a class="code" href="gpm-prefs_8c.html#a9">callback_combo_changed</a> (GtkWidget *widget, gpointer user_data)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320     GConfClient *client = NULL;
<a name="l00321"></a>00321     gint value;
<a name="l00322"></a>00322     gchar *policypath = NULL;
<a name="l00323"></a>00323     gchar *policyoption = NULL;
<a name="l00324"></a>00324     GPtrArray *policydata = NULL;
<a name="l00325"></a>00325     gint *pdata = NULL;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="comment">/* assertion checks */</span>
<a name="l00328"></a>00328     g_assert (widget);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     client = gconf_client_get_default ();
<a name="l00331"></a>00331     value = gtk_combo_box_get_active(GTK_COMBO_BOX (widget));
<a name="l00332"></a>00332     policypath = g_object_get_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>);
<a name="l00333"></a>00333     policydata = g_object_get_data ((GObject*) widget, <span class="stringliteral">"policydata"</span>);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="comment">/* we have to convert from the virtual mapping to a policy mapping */</span>
<a name="l00336"></a>00336     pdata = (gint*) g_ptr_array_index (policydata, value);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     g_debug (<span class="stringliteral">"[%s] = (%i)"</span>, policypath, *pdata);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">/* we have to convert to the gconf store string */</span>
<a name="l00341"></a>00341     policyoption = <a class="code" href="gpm-common_8c.html#a11">convert_policy_to_string</a> (*pdata);
<a name="l00342"></a>00342     gconf_client_set_string (client, policypath, policyoption, NULL);
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00352"></a>00352 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00353"></a><a class="code" href="gpm-prefs_8c.html#a10">00353</a> <a class="code" href="gpm-prefs_8c.html#a10">callback_hscale_changed</a> (GtkWidget *widget, gpointer user_data)
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355     GConfClient *client = NULL;
<a name="l00356"></a>00356     <span class="keyword">const</span> gchar *widgetname = NULL;
<a name="l00357"></a>00357     gchar *policypath = NULL;
<a name="l00358"></a>00358     gdouble value;
<a name="l00359"></a>00359     gint oldgconfvalue;
<a name="l00360"></a>00360     gdouble divisions = -1;
<a name="l00361"></a>00361     gboolean onbattery;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">/* assertion checks */</span>
<a name="l00364"></a>00364     g_assert (widget);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     client = gconf_client_get_default ();
<a name="l00367"></a>00367     policypath = g_object_get_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     value = gtk_range_get_value (GTK_RANGE (widget));
<a name="l00370"></a>00370     oldgconfvalue = gconf_client_get_int (client, policypath, NULL);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">/*</span>
<a name="l00373"></a>00373 <span class="comment">     * Code for divisions of 5 seconds</span>
<a name="l00374"></a>00374 <span class="comment">     */</span>
<a name="l00375"></a>00375     widgetname = gtk_widget_get_name (widget);
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (strcmp (widgetname, <span class="stringliteral">"hscale_ac_computer"</span>) == 0)
<a name="l00377"></a>00377         divisions = 5;
<a name="l00378"></a>00378     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (widgetname, <span class="stringliteral">"hscale_batteries_computer"</span>) == 0)
<a name="l00379"></a>00379         divisions = 5;
<a name="l00380"></a>00380     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (widgetname, <span class="stringliteral">"hscale_batteries_display"</span>) == 0)
<a name="l00381"></a>00381         divisions = 5;
<a name="l00382"></a>00382     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (widgetname, <span class="stringliteral">"hscale_ac_display"</span>) == 0)
<a name="l00383"></a>00383         divisions = 5;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="keywordflow">if</span> (divisions &gt; 0) {
<a name="l00386"></a>00386         <span class="keywordtype">double</span> double_segment = ((gdouble) value / divisions);
<a name="l00387"></a>00387         <span class="keywordtype">double</span> v2 = ceil(double_segment) * divisions;
<a name="l00388"></a>00388         gtk_range_set_value (GTK_RANGE (widget), v2);
<a name="l00389"></a>00389         <span class="comment">/*</span>
<a name="l00390"></a>00390 <span class="comment">         * If not different, then we'll return, and wait for the </span>
<a name="l00391"></a>00391 <span class="comment">         * proper event</span>
<a name="l00392"></a>00392 <span class="comment">         */</span>
<a name="l00393"></a>00393         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) v2 != (<span class="keywordtype">int</span>) value)
<a name="l00394"></a>00394             <span class="keywordflow">return</span>;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">/*</span>
<a name="l00398"></a>00398 <span class="comment">     * if calculated value not substantially different to existing</span>
<a name="l00399"></a>00399 <span class="comment">     * gconf value, then no point continuing</span>
<a name="l00400"></a>00400 <span class="comment">     */</span>
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (fabs (oldgconfvalue - value) &lt; 0.1)
<a name="l00402"></a>00402         <span class="keywordflow">return</span>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* if this is hscale for battery_low, then set upper range of hscale for</span>
<a name="l00405"></a>00405 <span class="comment">     * battery_critical maximum to value</span>
<a name="l00406"></a>00406 <span class="comment">     * (This stops criticalThreshold &gt; lowThreshold)</span>
<a name="l00407"></a>00407 <span class="comment">     */</span>
<a name="l00408"></a>00408     <span class="keywordflow">if</span> (strcmp (widgetname, <span class="stringliteral">"hscale_battery_low"</span>) == 0) {
<a name="l00409"></a>00409         GtkWidget *widget2;
<a name="l00410"></a>00410         widget2 = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00411"></a>00411             <span class="stringliteral">"hscale_battery_critical"</span>);
<a name="l00412"></a>00412         gtk_range_set_range (GTK_RANGE (widget2), 0, value);
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="comment">/* for AC and battery, change the brightness in real-time */</span>
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (<a class="code" href="gpm-prefs_8c.html#a3">gpm_is_on_mains</a> (&amp;onbattery)) {
<a name="l00417"></a>00417         <span class="keywordflow">if</span> ((!onbattery &amp;&amp; strcmp (widgetname, <span class="stringliteral">"hscale_ac_brightness"</span>) == 0) ||
<a name="l00418"></a>00418             (onbattery &amp;&amp; strcmp (widgetname, <span class="stringliteral">"hscale_batteries_brightness"</span>) == 0))
<a name="l00419"></a>00419             <a class="code" href="glibhal-extras_8c.html#a4">hal_set_brightness</a> (value);
<a name="l00420"></a>00420     } <span class="keywordflow">else</span>
<a name="l00421"></a>00421         g_warning (<a class="code" href="gpm-common_8h.html#a12">GPM_DBUS_SERVICE</a> <span class="stringliteral">".isOnBattery failed"</span>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     g_return_if_fail (policypath);
<a name="l00424"></a>00424     g_debug (<span class="stringliteral">"[%s] = (%f)"</span>, policypath, value);
<a name="l00425"></a>00425     gconf_client_set_int (client, policypath, (gint) value, NULL);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00433"></a>00433 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00434"></a><a class="code" href="gpm-prefs_8c.html#a11">00434</a> <a class="code" href="gpm-prefs_8c.html#a11">callback_help</a> (GtkWidget *widget, gpointer user_data)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436     <span class="comment">/* for now, show website */</span>
<a name="l00437"></a>00437     gnome_url_show (<a class="code" href="gpm-common_8h.html#a5">GPMURL</a>, NULL);
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00445"></a>00445 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00446"></a><a class="code" href="gpm-prefs_8c.html#a12">00446</a> <a class="code" href="gpm-prefs_8c.html#a12">callback_screensave</a> (GtkWidget *widget, gpointer user_data)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448     gboolean retval;
<a name="l00449"></a>00449     retval = g_spawn_command_line_async (<span class="stringliteral">"gnome-screensaver-preferences"</span>, NULL);
<a name="l00450"></a>00450     <span class="keywordflow">if</span> (!retval)
<a name="l00451"></a>00451         g_warning (<span class="stringliteral">"Couldn't execute gnome-screensaver-preferences"</span>);
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00461"></a>00461 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00462"></a><a class="code" href="gpm-prefs_8c.html#a13">00462</a> <a class="code" href="gpm-prefs_8c.html#a13">callback_check_changed</a> (GtkWidget *widget, gpointer user_data)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464     GConfClient *client = NULL;
<a name="l00465"></a>00465     gboolean value;
<a name="l00466"></a>00466     gchar *policypath = NULL;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <span class="comment">/* assertion checks */</span>
<a name="l00469"></a>00469     g_assert (widget);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     client = gconf_client_get_default ();
<a name="l00472"></a>00472     value = gtk_toggle_button_get_active (GTK_TOGGLE_BUTTON (widget));
<a name="l00473"></a>00473     policypath = g_object_get_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>);
<a name="l00474"></a>00474     g_return_if_fail (policypath);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     g_debug (<span class="stringliteral">"[%s] = (%i)"</span>, policypath, value);
<a name="l00477"></a>00477     gconf_client_set_bool (client, policypath, value, NULL);
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00483"></a>00483 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00484"></a><a class="code" href="gpm-prefs_8c.html#a14">00484</a> <a class="code" href="gpm-main_8c.html#a21">print_usage</a> (<span class="keywordtype">void</span>)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     g_print (<span class="stringliteral">"\nusage : gnome-power-preferences [--verbose] [--help]\n"</span>);
<a name="l00487"></a>00487     g_print (
<a name="l00488"></a>00488         <span class="stringliteral">"\n"</span>
<a name="l00489"></a>00489         <span class="stringliteral">"        --verbose               Show extra debugging\n"</span>
<a name="l00490"></a>00490         <span class="stringliteral">"        --help                  Show this information and exit\n"</span>
<a name="l00491"></a>00491         <span class="stringliteral">"\n"</span>);
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00501"></a>00501 <span class="keyword">static</span> gchar*
<a name="l00502"></a><a class="code" href="gpm-prefs_8c.html#a15">00502</a> <a class="code" href="gpm-prefs_8c.html#a15">format_value_callback_percent</a> (GtkScale *scale, gdouble value)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <span class="comment">/* assertion checks */</span>
<a name="l00505"></a>00505     g_assert (scale);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     <span class="keywordflow">return</span> g_strdup_printf (<span class="stringliteral">"%i%%"</span>, (gint) value);
<a name="l00508"></a>00508 }
<a name="l00509"></a>00509 
<a name="l00518"></a>00518 <span class="keyword">static</span> gchar*
<a name="l00519"></a><a class="code" href="gpm-prefs_8c.html#a16">00519</a> <a class="code" href="gpm-prefs_8c.html#a16">format_value_callback_percent_lcd</a> (GtkScale *scale, gdouble value)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <span class="keywordtype">int</span> *steps = NULL;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="comment">/* assertion checks */</span>
<a name="l00524"></a>00524     g_assert (scale);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     steps = g_object_get_data ((GObject*) GTK_WIDGET (scale), <span class="stringliteral">"lcdsteps"</span>);
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (!steps)
<a name="l00528"></a>00528         <span class="keywordflow">return</span> NULL;
<a name="l00529"></a>00529     <span class="keywordflow">return</span> g_strdup_printf (<span class="stringliteral">"%i%%"</span>, (gint) value * 100 / (*steps - 1));
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00538"></a>00538 <span class="keyword">static</span> gchar*
<a name="l00539"></a><a class="code" href="gpm-prefs_8c.html#a17">00539</a> <a class="code" href="gpm-prefs_8c.html#a17">format_value_callback_time</a> (GtkScale *scale, gdouble value)
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541     gchar unitstring[32];
<a name="l00542"></a>00542     GString *strvalue = NULL;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">/* assertion checks */</span>
<a name="l00545"></a>00545     g_assert (scale);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">if</span> ((gint) value == 0)
<a name="l00548"></a>00548         <span class="keywordflow">return</span> g_strdup_printf (<span class="stringliteral">"Never"</span>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     strvalue = <a class="code" href="gpm-common_8c.html#a15">get_timestring_from_minutes</a> (value);
<a name="l00551"></a>00551     strcpy (unitstring, strvalue-&gt;str);
<a name="l00552"></a>00552     g_string_free (strvalue, TRUE);
<a name="l00553"></a>00553     <span class="keywordflow">return</span> g_strdup_printf (<span class="stringliteral">"%s"</span>, unitstring);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00563"></a>00563 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00564"></a><a class="code" href="gpm-prefs_8c.html#a18">00564</a> <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="keyword">const</span> gchar *widgetname, <span class="keyword">const</span> gchar *policypath, gint policytype)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566     GConfClient *client = NULL;
<a name="l00567"></a>00567     GtkWidget *widget = NULL;
<a name="l00568"></a>00568     gint value;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="comment">/* assertion checks */</span>
<a name="l00571"></a>00571     g_assert (widgetname);
<a name="l00572"></a>00572     g_assert (policypath);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     client = gconf_client_get_default ();
<a name="l00575"></a>00575     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     g_object_set_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>, (gpointer) policypath);
<a name="l00578"></a>00578     g_object_set_data ((GObject*) widget, <span class="stringliteral">"policytype"</span>, (gpointer) policytype);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     value = gconf_client_get_int (client, policypath, NULL);
<a name="l00581"></a>00581     g_debug (<span class="stringliteral">"'%s' -&gt; [%s] = (%i)"</span>, widgetname, policypath, value);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="keywordflow">if</span> (policytype == <a class="code" href="gpm-prefs_8h.html#a3a1">POLICY_LCD</a>)
<a name="l00584"></a>00584         g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"format-value"</span>,
<a name="l00585"></a>00585             G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a16">format_value_callback_percent_lcd</a>), NULL);
<a name="l00586"></a>00586     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (policytype == <a class="code" href="gpm-prefs_8h.html#a3a0">POLICY_PERCENT</a>)
<a name="l00587"></a>00587         g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"format-value"</span>,
<a name="l00588"></a>00588             G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a15">format_value_callback_percent</a>), NULL);
<a name="l00589"></a>00589     <span class="keywordflow">else</span>
<a name="l00590"></a>00590         g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"format-value"</span>,
<a name="l00591"></a>00591             G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a17">format_value_callback_time</a>), NULL);
<a name="l00592"></a>00592     gtk_range_set_value (GTK_RANGE (widget), (<span class="keywordtype">int</span>) value);
<a name="l00593"></a>00593     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"value-changed"</span>,
<a name="l00594"></a>00594         G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a10">callback_hscale_changed</a>), NULL);
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00603"></a>00603 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00604"></a><a class="code" href="gpm-prefs_8c.html#a19">00604</a> <a class="code" href="gpm-prefs_8c.html#a19">checkbox_setup_action</a> (<span class="keyword">const</span> gchar *widgetname, <span class="keyword">const</span> gchar *policypath)
<a name="l00605"></a>00605 {
<a name="l00606"></a>00606     GConfClient *client = NULL;
<a name="l00607"></a>00607     GtkWidget *widget = NULL;
<a name="l00608"></a>00608     gboolean value;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="comment">/* assertion checks */</span>
<a name="l00611"></a>00611     g_assert (widgetname);
<a name="l00612"></a>00612     g_assert (policypath);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     client = gconf_client_get_default ();
<a name="l00615"></a>00615     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00616"></a>00616     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"clicked"</span>,
<a name="l00617"></a>00617         G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a13">callback_check_changed</a>), NULL);
<a name="l00618"></a>00618     g_object_set_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>, (gpointer) policypath);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     value = gconf_client_get_bool (client, policypath, NULL);
<a name="l00621"></a>00621     g_debug (<span class="stringliteral">"'%s' -&gt; [%s] = (%i)"</span>, widgetname, policypath, value);
<a name="l00622"></a>00622     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), value);
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00632"></a>00632 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00633"></a><a class="code" href="gpm-prefs_8c.html#a20">00633</a> <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="keyword">const</span> gchar *widgetname,
<a name="l00634"></a>00634     <span class="keyword">const</span> gchar *policypath,
<a name="l00635"></a>00635     GPtrArray *ptrarray)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     GConfClient *client = NULL;
<a name="l00638"></a>00638     GtkWidget *widget = NULL;
<a name="l00639"></a>00639     gchar *policyoption = NULL;
<a name="l00640"></a>00640     gint value;
<a name="l00641"></a>00641     gint a;
<a name="l00642"></a>00642     gint *pdata = NULL;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="comment">/* assertion checks */</span>
<a name="l00645"></a>00645     g_assert (widgetname);
<a name="l00646"></a>00646     g_assert (policypath);
<a name="l00647"></a>00647     g_assert (ptrarray);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     client = gconf_client_get_default ();
<a name="l00650"></a>00650     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, widgetname);
<a name="l00651"></a>00651     g_return_if_fail (widget);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     g_object_set_data ((GObject*) widget, <span class="stringliteral">"policypath"</span>, (gpointer) policypath);
<a name="l00654"></a>00654     g_object_set_data ((GObject*) widget, <span class="stringliteral">"policydata"</span>, (gpointer) ptrarray);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="comment">/* add text to combo boxes in order of parray */</span>
<a name="l00657"></a>00657     <span class="keywordflow">for</span> (a=0;a &lt; ptrarray-&gt;len;a++) {
<a name="l00658"></a>00658         pdata = (gint*) g_ptr_array_index (ptrarray, a);
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (*pdata == ACTION_SHUTDOWN)
<a name="l00660"></a>00660             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00661"></a>00661                 _(<span class="stringliteral">"Shutdown"</span>));
<a name="l00662"></a>00662         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pdata == ACTION_SUSPEND)
<a name="l00663"></a>00663             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00664"></a>00664                 _(<span class="stringliteral">"Suspend"</span>));
<a name="l00665"></a>00665         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pdata == ACTION_HIBERNATE)
<a name="l00666"></a>00666             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00667"></a>00667                 _(<span class="stringliteral">"Hibernate"</span>));
<a name="l00668"></a>00668         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pdata == ACTION_WARNING)
<a name="l00669"></a>00669             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00670"></a>00670                 _(<span class="stringliteral">"Send warning"</span>));
<a name="l00671"></a>00671         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*pdata == ACTION_NOTHING)
<a name="l00672"></a>00672             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00673"></a>00673                 _(<span class="stringliteral">"Do nothing"</span>));
<a name="l00674"></a>00674         <span class="keywordflow">else</span>
<a name="l00675"></a>00675             gtk_combo_box_append_text (GTK_COMBO_BOX (widget),
<a name="l00676"></a>00676                 <span class="stringliteral">"Unknown"</span>);
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     <span class="comment">/* we have to get the gconf string, and convert it into a policy option */</span>
<a name="l00680"></a>00680     policyoption = gconf_client_get_string (client, policypath, NULL);
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (!policyoption) {
<a name="l00682"></a>00682         g_warning (<span class="stringliteral">"Cannot find %s, maybe a bug in the gconf schema!"</span>, policyoption);
<a name="l00683"></a>00683         <span class="keywordflow">return</span>;
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/* select the correct entry, i.e. map the policy to virtual mapping */</span>
<a name="l00687"></a>00687     value = <a class="code" href="gpm-common_8c.html#a10">convert_string_to_policy</a> (policyoption);
<a name="l00688"></a>00688     <span class="keywordflow">for</span> (a=0;a &lt; ptrarray-&gt;len;a++) {
<a name="l00689"></a>00689         pdata = (<span class="keywordtype">int</span>*) g_ptr_array_index (ptrarray, a);
<a name="l00690"></a>00690         <span class="keywordflow">if</span> (*pdata == value) {
<a name="l00691"></a>00691             gtk_combo_box_set_active (GTK_COMBO_BOX (widget), a);
<a name="l00692"></a>00692             <span class="keywordflow">break</span>;
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">/* connect this signal up to the genric changed box */</span>
<a name="l00697"></a>00697     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"changed"</span>,
<a name="l00698"></a>00698         G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a9">callback_combo_changed</a>), NULL);
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00705"></a>00705 <span class="keywordtype">void</span>
<a name="l00706"></a><a class="code" href="gpm-prefs_8c.html#a21">00706</a> <a class="code" href="gpm-prefs_8c.html#a21">refresh_info_page</a> (<span class="keywordtype">void</span>)
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708     gchar *returnstring;
<a name="l00709"></a>00709     GtkWidget *widget = NULL;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     <span class="comment">/* set vendor */</span>
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (<a class="code" href="glibhal-main_8c.html#a3">hal_device_get_string</a> (<span class="stringliteral">"/org/freedesktop/Hal/devices/computer"</span>,
<a name="l00713"></a>00713                 <span class="stringliteral">"smbios.system.manufacturer"</span>,
<a name="l00714"></a>00714                 &amp;returnstring)) {
<a name="l00715"></a>00715         <a class="code" href="gpm-prefs_8c.html#a6">gtk_set_label</a> (<span class="stringliteral">"label_info_vendor"</span>, returnstring);
<a name="l00716"></a>00716         g_free (returnstring);
<a name="l00717"></a>00717     } <span class="keywordflow">else</span>
<a name="l00718"></a>00718         <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_info_vendor"</span>, FALSE);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="comment">/* set model */</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (<a class="code" href="glibhal-main_8c.html#a3">hal_device_get_string</a> (<span class="stringliteral">"/org/freedesktop/Hal/devices/computer"</span>,
<a name="l00722"></a>00722                 <span class="stringliteral">"smbios.system.product"</span>,
<a name="l00723"></a>00723                 &amp;returnstring)) {
<a name="l00724"></a>00724         <a class="code" href="gpm-prefs_8c.html#a6">gtk_set_label</a> (<span class="stringliteral">"label_info_model"</span>, returnstring);
<a name="l00725"></a>00725         g_free (returnstring);
<a name="l00726"></a>00726     } <span class="keywordflow">else</span>
<a name="l00727"></a>00727         <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_info_model"</span>, FALSE);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="comment">/* set formfactor */</span>
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (<a class="code" href="glibhal-main_8c.html#a3">hal_device_get_string</a> (<span class="stringliteral">"/org/freedesktop/Hal/devices/computer"</span>,
<a name="l00731"></a>00731                 <span class="stringliteral">"smbios.chassis.type"</span>,
<a name="l00732"></a>00732                 &amp;returnstring)) {
<a name="l00733"></a>00733         <a class="code" href="gpm-prefs_8c.html#a6">gtk_set_label</a> (<span class="stringliteral">"label_info_formfactor"</span>, returnstring);
<a name="l00734"></a>00734         g_free (returnstring);
<a name="l00735"></a>00735     } <span class="keywordflow">else</span>
<a name="l00736"></a>00736         <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"label_info_formfactor"</span>, FALSE);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">/* Hardcoded for now */</span>
<a name="l00739"></a>00739     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00740"></a>00740             <span class="stringliteral">"checkbutton_info_suspend"</span>);
<a name="l00741"></a>00741     gtk_widget_set_sensitive (GTK_WIDGET (widget), FALSE);
<a name="l00742"></a>00742     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), TRUE);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00745"></a>00745             <span class="stringliteral">"checkbutton_info_hibernate"</span>);
<a name="l00746"></a>00746     gtk_widget_set_sensitive (GTK_WIDGET (widget), FALSE);
<a name="l00747"></a>00747     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), TRUE);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00750"></a>00750             <span class="stringliteral">"checkbutton_info_cpufreq"</span>);
<a name="l00751"></a>00751     gtk_widget_set_sensitive (GTK_WIDGET (widget), FALSE);
<a name="l00752"></a>00752     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), FALSE);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00755"></a>00755             <span class="stringliteral">"checkbutton_info_lowpowermode"</span>);
<a name="l00756"></a>00756     gtk_widget_set_sensitive (GTK_WIDGET (widget), FALSE);
<a name="l00757"></a>00757     gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (widget), <a class="code" href="glibhal-extras_8c.html#a1">hal_is_laptop</a> ());
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="comment">/* TODO */</span>
<a name="l00760"></a>00760     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"frame_info_batteries"</span>, FALSE);
<a name="l00761"></a>00761     <a class="code" href="gpm-prefs_8c.html#a4">gtk_set_visibility</a> (<span class="stringliteral">"frame_info_ups"</span>, FALSE);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00771"></a>00771 <span class="keywordtype">int</span>
<a name="l00772"></a><a class="code" href="gpm-prefs_8c.html#a22">00772</a> <a class="code" href="gpm-main_8c.html#a23">main</a> (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     GtkWidget *widget = NULL;
<a name="l00775"></a>00775     GConfClient *client = NULL;
<a name="l00776"></a>00776     gint a;
<a name="l00777"></a>00777     gboolean has_gpm_connection;
<a name="l00778"></a>00778     gdouble value;
<a name="l00779"></a>00779     gint steps;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781     <span class="comment">/* provide dynamic storage for comboboxes */</span>
<a name="l00782"></a>00782     GPtrArray *ptrarr_button_power = NULL;
<a name="l00783"></a>00783     GPtrArray *ptrarr_button_suspend = NULL;
<a name="l00784"></a>00784     GPtrArray *ptrarr_button_lid = NULL;
<a name="l00785"></a>00785     GPtrArray *ptrarr_ac_fail = NULL;
<a name="l00786"></a>00786     GPtrArray *ptrarr_battery_critical = NULL;
<a name="l00787"></a>00787     GPtrArray *ptrarr_sleep_type = NULL;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="comment">/* provide pointers to enums */</span>
<a name="l00790"></a>00790     <span class="keywordtype">int</span> pSuspend    =   ACTION_SUSPEND;
<a name="l00791"></a>00791     <span class="keywordtype">int</span> pShutdown   =   ACTION_SHUTDOWN;
<a name="l00792"></a>00792     <span class="keywordtype">int</span> pHibernate  =   ACTION_HIBERNATE;
<a name="l00793"></a>00793     <span class="keywordtype">int</span> pNothing    =   ACTION_NOTHING;
<a name="l00794"></a>00794     <span class="keywordtype">int</span> pWarning    =   ACTION_WARNING;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     gtk_init (&amp;argc, &amp;argv);
<a name="l00797"></a>00797     gconf_init (argc, argv, NULL);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <a class="code" href="gpm-main_8c.html#a3">isVerbose</a> = FALSE;
<a name="l00800"></a>00800     <span class="keywordflow">for</span> (a=1; a &lt; argc; a++) {
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (strcmp (argv[a], <span class="stringliteral">"--verbose"</span>) == 0)
<a name="l00802"></a>00802             <a class="code" href="gpm-main_8c.html#a3">isVerbose</a> = TRUE;
<a name="l00803"></a>00803         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp (argv[a], <span class="stringliteral">"--help"</span>) == 0) {
<a name="l00804"></a>00804             <a class="code" href="gpm-main_8c.html#a21">print_usage</a> ();
<a name="l00805"></a>00805             <span class="keywordflow">return</span> EXIT_SUCCESS;
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keywordflow">if</span> (!<a class="code" href="gpm-main_8c.html#a3">isVerbose</a>)
<a name="l00810"></a>00810         g_log_set_handler (G_LOG_DOMAIN, G_LOG_LEVEL_DEBUG,
<a name="l00811"></a>00811             <a class="code" href="gpm-common_8c.html#a9">g_log_ignore</a>, NULL);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     <span class="comment">/* initialise gnome */</span>
<a name="l00814"></a>00814     gnome_program_init (<span class="stringliteral">"GNOME Power Preferences"</span>, VERSION,
<a name="l00815"></a>00815         LIBGNOMEUI_MODULE, argc, argv, NULL);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="comment">/* Get the GconfClient, tell it we want to monitor /apps/gnome-power */</span>
<a name="l00818"></a>00818     client = gconf_client_get_default ();
<a name="l00819"></a>00819     gconf_client_add_dir (client, <a class="code" href="gpm-common_8h.html#a1">GCONF_ROOT_SANS_SLASH</a>, GCONF_CLIENT_PRELOAD_NONE, NULL);
<a name="l00820"></a>00820     gconf_client_notify_add (client, <a class="code" href="gpm-common_8h.html#a1">GCONF_ROOT_SANS_SLASH</a>, 
<a name="l00821"></a>00821         <a class="code" href="gpm-main_8c.html#a5">callback_gconf_key_changed</a>, widget, NULL, NULL);
<a name="l00822"></a>00822     <span class="comment">/*</span>
<a name="l00823"></a>00823 <span class="comment">     * we add this even if it doesn't exist as gnome-screensaver might be </span>
<a name="l00824"></a>00824 <span class="comment">     * installed when g-p-m is running</span>
<a name="l00825"></a>00825 <span class="comment">     */</span>
<a name="l00826"></a>00826     gconf_client_notify_add (client, <a class="code" href="gpm-screensaver_8h.html#a4">GS_GCONF_ROOT_NO_SLASH</a>,
<a name="l00827"></a>00827         <a class="code" href="gpm-main_8c.html#a5">callback_gconf_key_changed</a>, widget, NULL, NULL);
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="comment">/* Initialise libnotify, if compiled in. */</span>
<a name="l00830"></a>00830     <span class="keywordflow">if</span> (!<a class="code" href="gpm-libnotify_8c.html#a1">libnotify_init</a> (<a class="code" href="gpm-common_8h.html#a3">NICENAME</a>))
<a name="l00831"></a>00831         g_error (<span class="stringliteral">"Cannot initialise libnotify!"</span>);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="comment">/* check if we have GNOME Screensaver, but have disabled dpms */</span>
<a name="l00834"></a>00834     <span class="keywordflow">if</span> (<a class="code" href="gpm-screensaver_8c.html#a2">gscreensaver_is_running</a> ())
<a name="l00835"></a>00835         <span class="keywordflow">if</span> (!gconf_client_get_bool (client, <a class="code" href="gpm-screensaver_8h.html#a3">GS_GCONF_ROOT</a> <span class="stringliteral">"dpms_enabled"</span>, NULL)) {
<a name="l00836"></a>00836             <a class="code" href="gpm-libnotify_8c.html#a0">libnotify_event</a> (<span class="stringliteral">"You have not got DPMS support enabled"</span>
<a name="l00837"></a>00837                      <span class="stringliteral">"in gnome-screensaver.\n"</span>
<a name="l00838"></a>00838                      <span class="stringliteral">"GNOME Power Manager will enable it now."</span>,
<a name="l00839"></a>00839                      <a class="code" href="gpm-libnotify_8h.html#a2">LIBNOTIFY_URGENCY_NORMAL</a>, NULL);
<a name="l00840"></a>00840             gconf_client_set_bool (client, 
<a name="l00841"></a>00841                 <a class="code" href="gpm-screensaver_8h.html#a3">GS_GCONF_ROOT</a> <span class="stringliteral">"dpms_enabled"</span>, TRUE, NULL);
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="comment">/* load the interface */</span>
<a name="l00845"></a>00845     <a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a> = glade_xml_new (GPM_DATA <span class="stringliteral">"preferences.glade"</span>, NULL, NULL);
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (!<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>)
<a name="l00847"></a>00847         g_error (<span class="stringliteral">"glade file failed to load, aborting"</span>);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     <span class="comment">/* Get the main_window quit */</span>
<a name="l00850"></a>00850     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"window_preferences"</span>);
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (!widget)
<a name="l00852"></a>00852         g_error (<span class="stringliteral">"Main window failed to load, aborting"</span>);
<a name="l00853"></a>00853     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"delete_event"</span>,
<a name="l00854"></a>00854         G_CALLBACK (gtk_main_quit), NULL);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     <span class="comment">/*</span>
<a name="l00857"></a>00857 <span class="comment">     * We should warn if g-p-m is not running - but still allow to continue</span>
<a name="l00858"></a>00858 <span class="comment">     * Note, that the query alone will be enough to lauch g-p-m using</span>
<a name="l00859"></a>00859 <span class="comment">     * the service file.</span>
<a name="l00860"></a>00860 <span class="comment">     */</span>
<a name="l00861"></a>00861     has_gpm_connection = <a class="code" href="gpm-prefs_8c.html#a2">gpm_is_on_ac</a> (&amp;a);
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (!has_gpm_connection)
<a name="l00863"></a>00863         <a class="code" href="gpm-libnotify_8c.html#a0">libnotify_event</a> (<span class="stringliteral">"Cannot connect to GNOME Power Manager.\n"</span>
<a name="l00864"></a>00864             <span class="stringliteral">"Make sure that it is running"</span>, <a class="code" href="gpm-libnotify_8h.html#a2">LIBNOTIFY_URGENCY_NORMAL</a>, NULL);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="comment">/* Set the button callbacks */</span>
<a name="l00867"></a>00867     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"button_close"</span>);
<a name="l00868"></a>00868     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"clicked"</span>, G_CALLBACK (gtk_main_quit), NULL);
<a name="l00869"></a>00869     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"button_help"</span>);
<a name="l00870"></a>00870     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"clicked"</span>, G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a11">callback_help</a>), NULL);
<a name="l00871"></a>00871     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"button_gnome_screensave"</span>);
<a name="l00872"></a>00872     g_signal_connect (G_OBJECT (widget), <span class="stringliteral">"clicked"</span>, G_CALLBACK (<a class="code" href="gpm-prefs_8c.html#a12">callback_screensave</a>), NULL);
<a name="l00873"></a>00873 
<a name="l00874"></a>00874     <span class="comment">/* set gtk enables/disables */</span>
<a name="l00875"></a>00875     <a class="code" href="gpm-prefs_8c.html#a7">recalc</a> ();
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="comment">/* checkboxes */</span>
<a name="l00878"></a>00878     <a class="code" href="gpm-prefs_8c.html#a19">checkbox_setup_action</a> (<span class="stringliteral">"checkbutton_display_icon"</span>,
<a name="l00879"></a>00879         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/display_icon"</span>);
<a name="l00880"></a>00880     <a class="code" href="gpm-prefs_8c.html#a19">checkbox_setup_action</a> (<span class="stringliteral">"checkbutton_display_icon_full"</span>,
<a name="l00881"></a>00881         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/display_icon_full"</span>);
<a name="l00882"></a>00882     <span class="comment">/*</span>
<a name="l00883"></a>00883 <span class="comment">     * Set up combo boxes with "ideal" values - if a enum is unavailable</span>
<a name="l00884"></a>00884 <span class="comment">     * e.g. hibernate has been disabled, then it will be filtered out</span>
<a name="l00885"></a>00885 <span class="comment">     * automatically.</span>
<a name="l00886"></a>00886 <span class="comment">     */</span>
<a name="l00887"></a>00887     <span class="comment">/* power button */</span>
<a name="l00888"></a>00888     ptrarr_button_power = g_ptr_array_new ();
<a name="l00889"></a>00889     g_ptr_array_add (ptrarr_button_power, (gpointer) &amp;pNothing);
<a name="l00890"></a>00890     g_ptr_array_add (ptrarr_button_power, (gpointer) &amp;pSuspend);
<a name="l00891"></a>00891     g_ptr_array_add (ptrarr_button_power, (gpointer) &amp;pHibernate);
<a name="l00892"></a>00892     g_ptr_array_add (ptrarr_button_power, (gpointer) &amp;pShutdown);
<a name="l00893"></a>00893     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_button_power"</span>, 
<a name="l00894"></a>00894         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/button_power"</span>, ptrarr_button_power);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="comment">/* sleep button */</span>
<a name="l00897"></a>00897     ptrarr_button_suspend = g_ptr_array_new ();
<a name="l00898"></a>00898     g_ptr_array_add (ptrarr_button_suspend, (gpointer) &amp;pNothing);
<a name="l00899"></a>00899     g_ptr_array_add (ptrarr_button_suspend, (gpointer) &amp;pSuspend);
<a name="l00900"></a>00900     g_ptr_array_add (ptrarr_button_suspend, (gpointer) &amp;pHibernate);
<a name="l00901"></a>00901     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_button_suspend"</span>,
<a name="l00902"></a>00902         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/button_suspend"</span>, ptrarr_button_power);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="comment">/* lid "button" */</span>
<a name="l00905"></a>00905     ptrarr_button_lid = g_ptr_array_new ();
<a name="l00906"></a>00906     g_ptr_array_add (ptrarr_button_lid, (gpointer) &amp;pNothing);
<a name="l00907"></a>00907     g_ptr_array_add (ptrarr_button_lid, (gpointer) &amp;pSuspend);
<a name="l00908"></a>00908     g_ptr_array_add (ptrarr_button_lid, (gpointer) &amp;pHibernate);
<a name="l00909"></a>00909     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_button_lid"</span>,
<a name="l00910"></a>00910         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/button_lid"</span>, ptrarr_button_lid);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <span class="comment">/* AC fail */</span>
<a name="l00913"></a>00913     ptrarr_ac_fail = g_ptr_array_new ();
<a name="l00914"></a>00914     g_ptr_array_add (ptrarr_ac_fail, (gpointer) &amp;pNothing);
<a name="l00915"></a>00915     g_ptr_array_add (ptrarr_ac_fail, (gpointer) &amp;pWarning);
<a name="l00916"></a>00916     g_ptr_array_add (ptrarr_ac_fail, (gpointer) &amp;pSuspend);
<a name="l00917"></a>00917     g_ptr_array_add (ptrarr_ac_fail, (gpointer) &amp;pHibernate);
<a name="l00918"></a>00918     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_ac_fail"</span>,
<a name="l00919"></a>00919         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/ac_fail"</span>, ptrarr_ac_fail);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="comment">/* battery critical */</span>
<a name="l00922"></a>00922     ptrarr_battery_critical = g_ptr_array_new ();
<a name="l00923"></a>00923     g_ptr_array_add (ptrarr_battery_critical, (gpointer) &amp;pNothing);
<a name="l00924"></a>00924     g_ptr_array_add (ptrarr_battery_critical, (gpointer) &amp;pSuspend);
<a name="l00925"></a>00925     g_ptr_array_add (ptrarr_battery_critical, (gpointer) &amp;pHibernate);
<a name="l00926"></a>00926     g_ptr_array_add (ptrarr_battery_critical, (gpointer) &amp;pShutdown);
<a name="l00927"></a>00927     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_battery_critical"</span>,
<a name="l00928"></a>00928         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/battery_critical"</span>, ptrarr_battery_critical);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <span class="comment">/* sleep type */</span>
<a name="l00931"></a>00931     ptrarr_sleep_type = g_ptr_array_new ();
<a name="l00932"></a>00932     g_ptr_array_add (ptrarr_sleep_type, (gpointer) &amp;pSuspend);
<a name="l00933"></a>00933     g_ptr_array_add (ptrarr_sleep_type, (gpointer) &amp;pHibernate);
<a name="l00934"></a>00934     <a class="code" href="gpm-prefs_8c.html#a20">combo_setup_dynamic</a> (<span class="stringliteral">"combobox_sleep_type"</span>,
<a name="l00935"></a>00935         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/sleep_type"</span>, ptrarr_sleep_type);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="comment">/* sliders */</span>
<a name="l00938"></a>00938     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_ac_computer"</span>,
<a name="l00939"></a>00939         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/ac/sleep_computer"</span>, <a class="code" href="gpm-prefs_8h.html#a3a2">POLICY_TIME</a>);
<a name="l00940"></a>00940     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_ac_display"</span>,
<a name="l00941"></a>00941         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/ac/sleep_display"</span>, <a class="code" href="gpm-prefs_8h.html#a3a2">POLICY_TIME</a>);
<a name="l00942"></a>00942     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_ac_brightness"</span>,
<a name="l00943"></a>00943         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/ac/brightness"</span>, <a class="code" href="gpm-prefs_8h.html#a3a1">POLICY_LCD</a>);
<a name="l00944"></a>00944     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_batteries_computer"</span>,
<a name="l00945"></a>00945         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/battery/sleep_computer"</span>, <a class="code" href="gpm-prefs_8h.html#a3a2">POLICY_TIME</a>);
<a name="l00946"></a>00946     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_batteries_display"</span>,
<a name="l00947"></a>00947         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/battery/sleep_display"</span>, <a class="code" href="gpm-prefs_8h.html#a3a2">POLICY_TIME</a>);
<a name="l00948"></a>00948     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_batteries_brightness"</span>,
<a name="l00949"></a>00949         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"policy/battery/brightness"</span>, <a class="code" href="gpm-prefs_8h.html#a3a1">POLICY_LCD</a>);
<a name="l00950"></a>00950     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_battery_low"</span>,
<a name="l00951"></a>00951         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/threshold_low"</span>, <a class="code" href="gpm-prefs_8h.html#a3a0">POLICY_PERCENT</a>);
<a name="l00952"></a>00952     <a class="code" href="gpm-prefs_8c.html#a18">hscale_setup_action</a> (<span class="stringliteral">"hscale_battery_critical"</span>,
<a name="l00953"></a>00953         <a class="code" href="gpm-common_8h.html#a2">GCONF_ROOT</a> <span class="stringliteral">"general/threshold_critical"</span>, <a class="code" href="gpm-prefs_8h.html#a3a0">POLICY_PERCENT</a>);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955     <span class="comment">/* set up upper limit for battery_critical */</span>
<a name="l00956"></a>00956     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"hscale_battery_low"</span>);
<a name="l00957"></a>00957     gtk_range_set_range (GTK_RANGE (widget), 0, 25);
<a name="l00958"></a>00958     value = gtk_range_get_value (GTK_RANGE (widget));
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>, <span class="stringliteral">"hscale_battery_critical"</span>);
<a name="l00961"></a>00961     gtk_range_set_range (GTK_RANGE (widget), 0, value);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">/* set the top end for LCD sliders */</span>
<a name="l00964"></a>00964     <span class="keywordflow">if</span> (<a class="code" href="glibhal-extras_8c.html#a9">hal_get_brightness_steps</a> (&amp;steps)) {
<a name="l00965"></a>00965         <span class="comment">/* only set steps if we have LCD device */</span>
<a name="l00966"></a>00966         widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00967"></a>00967             <span class="stringliteral">"hscale_ac_brightness"</span>);
<a name="l00968"></a>00968         gtk_range_set_range (GTK_RANGE (widget), 0, steps - 1);
<a name="l00969"></a>00969         g_object_set_data ((GObject*) widget, <span class="stringliteral">"lcdsteps"</span>, (gpointer) &amp;steps);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         widget = glade_xml_get_widget (<a class="code" href="gpm-prefs_8c.html#a0">all_pref_widgets</a>,
<a name="l00972"></a>00972             <span class="stringliteral">"hscale_batteries_brightness"</span>);
<a name="l00973"></a>00973         gtk_range_set_range (GTK_RANGE (widget), 0, steps - 1);
<a name="l00974"></a>00974         g_object_set_data ((GObject*) widget, <span class="stringliteral">"lcdsteps"</span>, (gpointer) &amp;steps);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="comment">/* set up info page */</span>
<a name="l00978"></a>00978     <a class="code" href="gpm-prefs_8c.html#a21">refresh_info_page</a> ();
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">/* main loop */</span>
<a name="l00981"></a>00981     gtk_main ();
<a name="l00982"></a>00982     g_ptr_array_free (ptrarr_button_power, TRUE);
<a name="l00983"></a>00983     g_ptr_array_free (ptrarr_button_suspend, TRUE);
<a name="l00984"></a>00984     g_ptr_array_free (ptrarr_button_lid, TRUE);
<a name="l00985"></a>00985     g_ptr_array_free (ptrarr_ac_fail, TRUE);
<a name="l00986"></a>00986     g_ptr_array_free (ptrarr_battery_critical, TRUE);
<a name="l00987"></a>00987     g_ptr_array_free (ptrarr_sleep_type, TRUE);
<a name="l00988"></a>00988     <span class="keywordflow">return</span> 0;
<a name="l00989"></a>00989 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Oct 4 15:28:18 2005 for GNOME Power Manager by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
